Description: >
    Jonathan Garrels |
    This template deploys the network infrastructure for the Udagram web app.


Parameters:
    EnvironmentName:
        Description: The environment name that will be prefixed to resource names.
        Type: String
    
    VpcCIDR:
        Description: The IP range (CIDR notation) for the VPC.
        Type: String
        Default: 10.0.0.0/16

    PublicSubnet1CIDR:
        Description: The IP range (CIDR notation) for the public subnet in the first Availability zone.
        Type: String
        Default: 10.0.0.0/24
    
    PublicSubnet2CIDR:
        Description: The IP range (CIDR notation) for the public subnet in the second Availability zone.
        Type: String
        Default: 10.0.1.0/24

    PrivateSubnet1CIDR:
        Description: The IP range (CIDR notation) for the private subnet in the first Availability zone.
        Type: String
        Default: 10.0.2.0/24
        
    PrivateSubnet2CIDR:
        Description: The IP range (CIDR notation) for the private subnet in the second Availability zone.
        Type: String
        Default: 10.0.3.0/24


Resources:
    VPC:
        Type: AWS::EC2::VPC
        Properties:
            CidrBlock: !Ref VpcCIDR
            EnableDnsHostnames: true
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName} - VPC

    PublicSubnet1:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            AvailabilityZone: !Select [0, !GetAZs '']
            CidrBlock: !Ref PublicSubnet1CIDR
            MapPublicIpOnLaunch: true
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName} Public Subnet (AZ1)
    
    PublicSubnet2:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            AvailabilityZone: !Select [1, !GetAZs '']
            CidrBlock: !Ref PublicSubnet2CIDR
            MapPublicIpOnLaunch: true
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName} Public Subnet (AZ2)
    
    PrivateSubnet1:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            AvailabilityZone: !Select [0, !GetAZs '']
            CidrBlock: !Ref PrivateSubnet1CIDR
            MapPublicIpOnLaunch: false
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName} Private Subnet (AZ1)

    PrivateSubnet2:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            AvailabilityZone: !Select [1, !GetAZs '']
            CidrBlock: !Ref PrivateSubnet2CIDR
            MapPublicIpOnLaunch: false
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName} Private Subnet (AZ2)


Outputs:
    VPC:
        Description: Reference to the created VPC.
        Value: !Ref VPC
        Export:
            Name: !Sub ${EnvironmentName}-VPC

    PublicSubnets:
        Description: A list of the public subnets.
        Value: !Join [",", [!Ref PublicSubnet1, !Ref PublicSubnet2]]
        Export:
            Name: !Sub ${EnvironmentName}-PUBLIC-SUBNETS

    PublicSubnet1:
        Description: A reference to the public subnet in the 1st AZ.
        Value: !Ref PublicSubnet1
        Export:
            Name: !Sub ${EnvironmentName}-PUBLIC-SUBNET-1

    PublicSubnet2:
        Description: A reference to the public subnet in the 2nd AZ.
        Value: !Ref PublicSubnet2
        Export:
            Name: !Sub ${EnvironmentName}-PUBLIC-SUBNET-2
        
    PrivateSubnets:
        Description: A list of the private subnets.
        Value: !Join [",", [!Ref PublicSubnet1, !Ref PublicSubnet2]]
        Export:
            Name: !Sub ${EnvironmentName}-PRIVATE-SUBNETS

    PrivateSubnet1:
        Description: A reference to the private subnet in the 1st AZ.
        Value: !Ref PrivateSubnet1
        Export:
            Name: !Sub ${EnvironmentName}-PRIVATE-SUBNET-1
        
    PrivateSubnet2:
        Description: A reference to the private subnet in the 2nd AZ.
        Value: !Ref PrivateSubnet2
        Export:
            Name: !Sub ${EnvironmentName}-PRIVATE-SUBNET-2